---
# Configure BGP on arca-router via NETCONF
#
# Usage:
#   ansible-playbook -i inventory/hosts.ini configure_bgp.yml
#
# This playbook demonstrates:
# - Configure routing-options (AS number, router-id)
# - Configure BGP groups (IBGP, EBGP)
# - Configure BGP neighbors
# - Jinja2 variable substitution

- name: Configure BGP
  hosts: routers
  gather_facts: false

  vars:
    # Global routing options
    local_as: 65001
    router_id: 10.0.1.1

    # BGP groups
    bgp_groups:
      - name: IBGP
        type: internal
        neighbors:
          - address: 10.0.1.2
            peer_as: 65001
            description: "Internal BGP Peer"
            local_address: 10.0.1.1
          - address: 10.0.1.3
            peer_as: 65001
            description: "Internal BGP Peer 2"
            local_address: 10.0.1.1

      - name: EBGP
        type: external
        neighbors:
          - address: 10.0.2.2
            peer_as: 65002
            description: "External BGP Peer - ISP1"
          - address: 10.0.3.2
            peer_as: 65003
            description: "External BGP Peer - ISP2"

  tasks:
    - name: Configure BGP
      block:
        - name: Lock candidate datastore
          ansible.netcommon.netconf_rpc:
            rpc: lock
            content: |
              <target>
                <candidate/>
              </target>

        - name: Configure routing options
          ansible.netcommon.netconf_config:
            target: candidate
            content: |
              <config xmlns="urn:ietf:params:xml:ns:netconf:base:1.0">
                <routing-options xmlns="urn:arca:router:config:1.0">
                  <autonomous-system>{{ local_as }}</autonomous-system>
                  <router-id>{{ router_id }}</router-id>
                </routing-options>
              </config>

        - name: Display routing options
          ansible.builtin.debug:
            msg: "Configured AS {{ local_as }}, Router-ID {{ router_id }}"

        - name: Configure BGP group {{ item.name }}
          ansible.netcommon.netconf_config:
            target: candidate
            content: |
              <config xmlns="urn:ietf:params:xml:ns:netconf:base:1.0">
                <protocols xmlns="urn:arca:router:config:1.0">
                  <bgp>
                    <group>
                      <name>{{ item.name }}</name>
                      <type>{{ item.type }}</type>
                      {% for neighbor in item.neighbors %}
                      <neighbor>
                        <address>{{ neighbor.address }}</address>
                        <peer-as>{{ neighbor.peer_as }}</peer-as>
                        <description>{{ neighbor.description }}</description>
                        {% if neighbor.local_address is defined %}
                        <local-address>{{ neighbor.local_address }}</local-address>
                        {% endif %}
                      </neighbor>
                      {% endfor %}
                    </group>
                  </bgp>
                </protocols>
              </config>
          loop: "{{ bgp_groups }}"

        - name: Display BGP configuration
          ansible.builtin.debug:
            msg: "Configured {{ bgp_groups | length }} BGP groups"

        - name: Commit configuration
          ansible.netcommon.netconf_rpc:
            rpc: commit

        - name: Display commit result
          ansible.builtin.debug:
            msg: "BGP configuration committed successfully"

      rescue:
        - name: Discard changes on error
          ansible.netcommon.netconf_rpc:
            rpc: discard-changes
          ignore_errors: true

        - name: Display error
          ansible.builtin.debug:
            msg: "BGP configuration failed, changes discarded"

        - name: Fail task
          ansible.builtin.fail:
            msg: "BGP configuration failed"

      always:
        - name: Unlock candidate datastore
          ansible.netcommon.netconf_rpc:
            rpc: unlock
            content: |
              <target>
                <candidate/>
              </target>
          ignore_errors: true

    - name: Verify BGP configuration
      ansible.netcommon.netconf_rpc:
        rpc: get-config
        content: |
          <source>
            <running/>
          </source>
          <filter>
            <protocols xmlns="urn:arca:router:config:1.0">
              <bgp/>
            </protocols>
          </filter>
      register: bgp_config

    - name: Display BGP running config
      ansible.builtin.debug:
        var: bgp_config.stdout
